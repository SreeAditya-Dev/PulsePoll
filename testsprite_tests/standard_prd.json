{
  "meta": {
    "project": "Real-Time Poll Rooms",
    "date": "2026-02-15",
    "prepared_by": "Generated by TestSprite"
  },
  "product_overview": "A lightweight web backend for creating shareable single-choice polls, collecting votes persistently, and broadcasting live results to viewers using Socket.IO. Requirements and acceptance criteria follow the assignment in assignment.txt (pages 1-2).",
  "core_goals": [
    "Allow users to create polls with a question and multiple options and generate a shareable link.",
    "Enable anyone with the share link to view a poll and cast a single-choice vote.",
    "Provide real-time result updates to all viewers using WebSockets (Socket.IO).",
    "Mitigate repeat/abusive voting using at least two mechanisms (IP rate limiting and client fingerprinting).",
    "Persist polls and votes in the database so results survive restarts and refreshes."
  ],
  "features": [
    {
      "name": "Poll Creation API",
      "description": "Create a new poll by submitting a question, options, and a client fingerprint; returns a pollId and a shareable shareCode.",
      "user_flows": [
        "POST /api/polls with body { question: \"What's your favorite color?\", options: [\"Red\",\"Blue\"], fingerprint: \"fp123\" } -> Receive 201 with { pollId: \"uuid\", shareCode: \"abcd1234\" } -> GET /api/polls/abcd1234 -> Receive 200 with { poll, options, tallies, totalVotes: 0, hasVoted: false }",
        "POST /api/polls with body { options: [\"Only one option\"] , fingerprint: \"fp123\" } -> Receive 400 Validation error (missing question / fewer than 2 options)",
        "POST /api/polls with body { question: \"Q\", options: [array of 11 options], fingerprint: \"fp123\" } -> Receive 400 Validation error (too many options > 10)"
      ]
    },
    {
      "name": "Poll Retrieval API",
      "description": "Fetch poll details by shareCode including options, per-option tallies, total votes, and whether the current client has voted.",
      "user_flows": [
        "GET /api/polls/:shareCode (e.g., GET /api/polls/abcd1234) -> Receive 200 with { poll: {...}, options: [...], tallies: { optionId: count }, totalVotes: number, hasVoted: boolean }",
        "GET /api/polls/:shareCode with request header X-Fingerprint: fp123 -> Receive 200 with hasVoted: true (if fingerprint previously recorded)",
        "GET /api/polls/nonexistent -> Receive 404 Poll not found"
      ]
    },
    {
      "name": "Vote Submission API",
      "description": "Submit a single-choice vote for a poll option. The endpoint enforces anti-abuse checks (IP rate limiting and fingerprint deduplication), returns success, and triggers real-time updates.",
      "user_flows": [
        "POST /api/polls/:shareCode/vote (e.g., POST /api/polls/abcd1234/vote) with body { optionId: \"opt-1\", fingerprint: \"fp123\" } -> Receive 200 { success: true, message: \"Vote recorded\" } -> Socket.IO room for shareCode abcd1234 emits 'vote_update' containing updated tallies",
        "POST /api/polls/:shareCode/vote with invalid optionId -> Receive 404 Poll not found or option not found",
        "POST /api/polls/:shareCode/vote with fingerprint that already voted -> Receive 409 Already voted (fingerprint constraint)",
        "POST /api/polls/:shareCode/vote after poll closed/expired -> Receive 410 Poll is no longer active"
      ]
    },
    {
      "name": "Health Check",
      "description": "Simple endpoint to verify the server is running and healthy.",
      "user_flows": [
        "GET /api/health -> Receive 200 { status: \"ok\" }",
        "GET /api/health -> Connection refused / network error (server offline) â€” client detects service unavailable"
      ]
    },
    {
      "name": "Real-Time Socket.IO",
      "description": "WebSocket (Socket.IO) support for clients to join a poll room by shareCode and receive immediate vote updates when votes are cast.",
      "user_flows": [
        "Client connects to Socket.IO server (ws://<host>) -> Emits event 'join_poll' with payload { shareCode: \"abcd1234\" } -> Server acknowledges with 'joined' or room metadata",
        "Client connected to room abcd1234 receives a 'vote_update' event after another client POSTs /api/polls/abcd1234/vote -> Receive 'vote_update' with updated tallies and totalVotes",
        "Client emits 'join_poll' with invalid shareCode -> Server emits 'error' or 'join_failed' -> Client receives error event (cannot join invalid room)"
      ]
    },
    {
      "name": "Anti-Abuse Rate Limiting",
      "description": "Middleware enforces IP-based rate limiting and fingerprint-based deduplication to reduce repeat/abusive voting; implemented as request-level checks applied to vote submissions.",
      "user_flows": [
        "POST /api/polls/:shareCode/vote with a unique fingerprint and new IP -> Receive 200 { success: true } (happy path allowed by middleware)",
        "POST /api/polls/:shareCode/vote with same fingerprint used in a previous vote -> Receive 409 Already voted (fingerprint constraint) (error path)",
        "Multiple POST /api/polls/:shareCode/vote requests from same IP in short window -> Receive 409 Already voted (IP rate limit triggered) (error path)",
        "POST /api/polls/:shareCode/vote after user clears fingerprint (e.g., new fingerprint from incognito) -> Receive 200 { success: true } (known limitation: fingerprint can be bypassed by changing client state)"
      ]
    }
  ],
  "code_summary": {
    "version": "2",
    "type": "backend",
    "tech_stack": [
      "Node.js",
      "Express",
      "TypeScript",
      "Socket.IO",
      "Supabase (PostgreSQL)",
      "Redis"
    ],
    "features": [
      {
        "name": "Poll Creation API",
        "description": "Create new polls with a question and multiple options",
        "files": [
          "backend/src/routes/polls.ts"
        ],
        "endpoints": [
          {
            "method": "POST",
            "path": "/api/polls",
            "description": "Create a new poll with question and options",
            "auth_required": false,
            "request_schema": {
              "body": {
                "question": "string",
                "options": "string[]",
                "fingerprint": "string"
              }
            },
            "response_schema": {
              "201": "{ pollId: string, shareCode: string }",
              "400": "Validation error (missing question, < 2 options, > 10 options)"
            }
          }
        ],
        "depends_on": []
      },
      {
        "name": "Poll Retrieval API",
        "description": "Fetch poll details by share code including options and vote counts",
        "files": [
          "backend/src/routes/polls.ts"
        ],
        "endpoints": [
          {
            "method": "GET",
            "path": "/api/polls/:shareCode",
            "description": "Get poll details, options, and vote tallies",
            "auth_required": false,
            "response_schema": {
              "200": "{ poll: Poll, options: PollOption[], tallies: Record<string, number>, totalVotes: number, hasVoted: boolean }",
              "404": "Poll not found"
            }
          }
        ],
        "depends_on": [
          "Poll Creation API"
        ]
      },
      {
        "name": "Vote Submission API",
        "description": "Cast a vote on a poll option with anti-abuse checks",
        "files": [
          "backend/src/routes/polls.ts",
          "backend/src/middleware/rateLimit.ts"
        ],
        "endpoints": [
          {
            "method": "POST",
            "path": "/api/polls/:shareCode/vote",
            "description": "Submit a vote for a specific option",
            "auth_required": false,
            "request_schema": {
              "body": {
                "optionId": "string",
                "fingerprint": "string"
              }
            },
            "response_schema": {
              "200": "{ success: true, message: string }",
              "404": "Poll not found or option not found",
              "409": "Already voted (IP rate limit or fingerprint constraint)",
              "410": "Poll is no longer active"
            }
          }
        ],
        "depends_on": [
          "Poll Creation API",
          "Poll Retrieval API"
        ]
      },
      {
        "name": "Health Check",
        "description": "Basic health check endpoint",
        "files": [
          "backend/src/index.ts"
        ],
        "endpoints": [
          {
            "method": "GET",
            "path": "/api/health",
            "description": "Returns server health status",
            "auth_required": false,
            "response_schema": {
              "200": "{ status: ok }"
            }
          }
        ],
        "depends_on": []
      },
      {
        "name": "Real-Time Socket.IO",
        "description": "WebSocket-based real-time vote updates using Socket.IO rooms",
        "files": [
          "backend/src/socket/pollRooms.ts"
        ],
        "endpoints": [],
        "depends_on": [
          "Vote Submission API"
        ]
      },
      {
        "name": "Anti-Abuse Rate Limiting",
        "description": "IP-based and fingerprint-based vote deduplication",
        "files": [
          "backend/src/middleware/rateLimit.ts"
        ],
        "endpoints": [],
        "depends_on": []
      }
    ],
    "known_limitations": [
      {
        "issue": "Users can bypass fingerprinting by using incognito mode or a different browser",
        "location": "backend/src/routes/polls.ts",
        "impact": "Allows duplicate votes from same user with different fingerprints"
      },
      {
        "issue": "Users behind same NAT/VPN share an IP and may be blocked",
        "location": "backend/src/middleware/rateLimit.ts",
        "impact": "Legitimate users may be falsely blocked from voting"
      },
      {
        "issue": "No authentication system - polls are fully anonymous",
        "location": "backend/src/routes/polls.ts",
        "impact": "No ability to manage or delete polls after creation"
      }
    ]
  }
}
